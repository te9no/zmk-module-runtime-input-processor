#include <physical_layouts.dtsi>
#include <dt-bindings/zmk/matrix_transform.h>
#include <dt-bindings/zmk/pointing.h>
#include <zephyr/dt-bindings/input/input-event-codes.h>
#include <behaviors/runtime-input-processors.dtsi>

/ {
	physical_layout: physical_layout {
		compatible = "zmk,physical-layout";
		display-name = "Custom Layout";
		keys
		= <&key_physical_attrs 100 100    0    0      0    0    0>
		, <&key_physical_attrs 100 100    0  100      0    0    0>
		, <&key_physical_attrs 100 100    0  200      0    0    0>
		, <&key_physical_attrs 100 100    0  300      0    0    0>
		;
		transform = <&transform0>;
	};
	transform0: transform0 {
		compatible = "zmk,matrix-transform";
		columns = <2>;
		rows = <2>;
		map = <
		RC(0,0)  RC(0,1)  RC(1,0)  RC(1, 1)
		>;
	};
	
	runtime_input_processor: runtime_input_processor {
		compatible = "zmk,input-processor-runtime";
		processor-label = "default";
		type = <INPUT_EV_REL>;
		x-codes = <INPUT_REL_X>;
		y-codes = <INPUT_REL_Y>;
		track-remainders;
	};
};

#include <dt-bindings/zmk/keys.h>
#include <behaviors.dtsi>
#include <dt-bindings/zmk/kscan_mock.h>

&mmv_input_listener {
	input-processors = <&runtime_input_processor>;
};

/ {
	behaviors {
		hdpi: hdpi {
			compatible = "zmk,behavior-input-processor-temp-config";
			#binding-cells = <0>;
			processor-name = "default";
			scale-multiplier = <2>;
			scale-divisor = <1>;
		};
		ldpi: ldpi {
			compatible = "zmk,behavior-input-processor-temp-config";
			#binding-cells = <0>;
			processor-name = "default";
			scale-multiplier = <1>;
			scale-divisor = <2>;
		};
	};

	keymap {
		compatible = "zmk,keymap";
		
		default_layer {
			bindings = <
			&mmv MOVE_UP
			&hdpi
			&ldpi
			&mmv MOVE_RIGHT
			>;
		};
	};
};

&kscan {
	events = <
	ZMK_MOCK_PRESS(0,0,10)
	ZMK_MOCK_RELEASE(0,0,10)
	// High DPI
	ZMK_MOCK_PRESS(0,1,10)
	ZMK_MOCK_PRESS(0,0,10)
	ZMK_MOCK_RELEASE(0,0,10)
	ZMK_MOCK_RELEASE(0,1,10)
	// Low DPI
	ZMK_MOCK_PRESS(1,0,10)
	ZMK_MOCK_PRESS(0,0,10)
	ZMK_MOCK_RELEASE(0,0,10)
	ZMK_MOCK_RELEASE(1,0,10)
	>;
};